"""
Local Wage Request System (single-file Flask app)
Features implemented:
- One-time onboarding (photo, Aadhaar image, secondary proof, role, UPI details)
- User login (email/identifier + password)
- Worker dashboard: log tasks, request wage (amount, mode, reason)
- Admin dashboard: view/approve/reject/mark paid, export CSV
- File uploads saved to 'uploads/' with filename sanitation
- SQLite DB via SQLAlchemy
- Passwords hashed with werkzeug
- Only superadmin can create admins, normal users can only register as workers
- UPI number collection and QR code upload

How to run (Linux / Windows with Python 3.8+):
1. python -m venv venv
2. venv\Scripts\activate (Windows) or source venv/bin/activate (mac/linux)
3. pip install flask sqlalchemy flask_sqlalchemy flask_login
4. python app.py
5. Open http://127.0.0.1:5000/ OR http://[YOUR-IP-ADDRESS]:5000/ from any device on same WiFi

NOTE: This is a minimal local-network-ready prototype. For production/local network security, add HTTPS, file encryption, stricter upload validation, rate-limiting, and secure backups.
"""

from flask import Flask, render_template_string, request, redirect, url_for, flash, send_file
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager, login_user, logout_user, login_required, current_user, UserMixin
from werkzeug.security import generate_password_hash, check_password_hash
from werkzeug.utils import secure_filename
import os
import csv
import socket
import sqlite3
from io import StringIO
from datetime import datetime

BASE_DIR = os.path.dirname(os.path.abspath(__file__))
UPLOAD_FOLDER = os.path.join(BASE_DIR, 'uploads')
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

app = Flask(__name__)
app.config['SECRET_KEY'] = 'change-me-to-a-strong-secret'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///' + os.path.join(BASE_DIR, 'wage_system.db')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB max file size

db = SQLAlchemy(app)
login_manager = LoginManager(app)
login_manager.login_view = 'login'

# --- Models ---
class User(db.Model, UserMixin):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(120), nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)
    password_hash = db.Column(db.String(200), nullable=False)
    role = db.Column(db.String(50), nullable=False, default='worker')  # worker / admin / superadmin
    phone = db.Column(db.String(20))  # Added phone number
    upi_id = db.Column(db.String(100))  # Added UPI ID (e.g., 1234567890@upi)
    photo = db.Column(db.String(300))
    aadhaar = db.Column(db.String(300))
    proof = db.Column(db.String(300))
    upi_qr = db.Column(db.String(300))  # Added UPI QR code image
    created_by = db.Column(db.Integer, db.ForeignKey('user.id'))  # Who created this user
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # Relationships - FIXED with foreign_keys parameter
    created_users = db.relationship('User', backref='creator', remote_side=[id], lazy=True)
    tasks = db.relationship('Task', backref='user', lazy=True)
    wage_requests = db.relationship('WageRequest', backref='user', lazy=True, foreign_keys='WageRequest.user_id')
    processed_payments = db.relationship('WageRequest', backref='processor', lazy=True, foreign_keys='WageRequest.paid_by')

    def set_password(self, password):
        self.password_hash = generate_password_hash(password)
    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

class Task(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    title = db.Column(db.String(200))
    details = db.Column(db.Text)
    duration = db.Column(db.String(50))
    date = db.Column(db.DateTime, default=datetime.utcnow)

class WageRequest(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    amount = db.Column(db.Float, nullable=False)
    mode = db.Column(db.String(20))  # cash / online / upi
    reason = db.Column(db.Text)
    status = db.Column(db.String(20), default='pending')  # pending / approved / rejected / paid
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    admin_note = db.Column(db.Text)
    transaction_id = db.Column(db.String(100))  # Added transaction ID for online/UPI payments
    paid_by = db.Column(db.Integer, db.ForeignKey('user.id'))  # Which admin processed payment

# --- Login loader ---
@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

# --- Get local IP address ---
def get_local_ip():
    """Get the local IP address of the machine"""
    try:
        # Create a socket connection to get the local IP
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        # Doesn't need to be reachable
        s.connect(('8.8.8.8', 80))
        ip_address = s.getsockname()[0]
        s.close()
        return ip_address
    except:
        return "127.0.0.1"

# --- Check and update database schema ---
def check_and_update_schema():
    """Check if database schema needs updating and handle it"""
    db_path = os.path.join(BASE_DIR, 'wage_system.db')
    
    if not os.path.exists(db_path):
        print("Creating new database with updated schema...")
        return
    
    # Connect to SQLite directly to check schema
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # Check if 'phone' column exists in user table
    cursor.execute("PRAGMA table_info(user)")
    columns = [column[1] for column in cursor.fetchall()]
    
    missing_columns = []
    required_columns = ['phone', 'upi_id', 'upi_qr', 'created_by']
    
    for col in required_columns:
        if col not in columns:
            missing_columns.append(col)
    
    conn.close()
    
    if missing_columns:
        print(f"Database schema outdated. Missing columns: {missing_columns}")
        print("Creating backup and recreating database...")
        
        # Create backup of old database
        backup_path = db_path + '.backup'
        if os.path.exists(backup_path):
            os.remove(backup_path)
        os.rename(db_path, backup_path)
        
        # Delete backup uploads folder if exists
        backup_uploads = os.path.join(BASE_DIR, 'uploads.backup')
        if os.path.exists(backup_uploads):
            import shutil
            shutil.rmtree(backup_uploads)
        
        # Rename current uploads folder
        if os.path.exists(UPLOAD_FOLDER):
            os.rename(UPLOAD_FOLDER, backup_uploads)
        
        print(f"Old database backed up to: {backup_path}")
        print(f"Old uploads backed up to: {backup_uploads}")
        print("New database will be created with updated schema.")

# --- DB initialize / seed admin if empty ---
def initialize_database():
    """Initialize database and create admin user if it doesn't exist"""
    # First check and update schema if needed
    check_and_update_schema()
    
    with app.app_context():
        db.create_all()
        
        if not User.query.filter_by(role='superadmin').first():
            a = User(name='Super Admin', email='superadmin@local', role='superadmin')
            a.set_password('superadmin123')
            db.session.add(a)
            db.session.commit()
            print("="*60)
            print("IMPORTANT: Default superadmin created!")
            print("Email: superadmin@local")
            print("Password: superadmin123")
            print("="*60)

# --- Helpers ---
def save_upload(f):
    if not f:
        return None
    filename = secure_filename(f.filename)
    timestamp = datetime.utcnow().strftime('%Y%m%d%H%M%S')
    filename = f"{timestamp}_{filename}"
    path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
    f.save(path)
    return filename

# --- Routes / Templates ---
HOME_TPL = '''
<!doctype html><title>Local Wage System</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
        color: #333;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
    }
    a {
        color: #4CAF50;
        text-decoration: none;
        padding: 8px 16px;
        margin: 5px;
        border: 1px solid #4CAF50;
        border-radius: 4px;
        display: inline-block;
    }
    a:hover {
        background-color: #4CAF50;
        color: white;
    }
    .network-info {
        background-color: #e8f5e9;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        border-left: 4px solid #4CAF50;
    }
    .instructions {
        margin-top: 20px;
        padding: 15px;
        background-color: #f0f0f0;
        border-radius: 5px;
    }
    .upi-info {
        background-color: #e3f2fd;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        border-left: 4px solid #2196F3;
    }
    .admin-only {
        background-color: #fff3cd;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        border-left: 4px solid #ff9800;
    }
</style>
<div class="container">
<h2>Local Wage Request System</h2>
<div class="network-info">
    <strong>Network Access Information:</strong><br>
    ‚Ä¢ Local URL: <a href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a><br>
    ‚Ä¢ Network URL: <a href="http://{{network_ip}}:5000/">http://{{network_ip}}:5000/</a>
</div>

<div class="upi-info">
    <strong>üí≥ UPI Payment Support:</strong><br>
    ‚Ä¢ Workers can add UPI ID and QR code during registration<br>
    ‚Ä¢ Admins can make UPI payments directly<br>
    ‚Ä¢ Track all transactions with IDs
</div>

{% if current_user.is_authenticated %}
  <div class="welcome">
  Hello <strong>{{current_user.name}}</strong> ({{current_user.role}}) | <a href="{{url_for('logout')}}">Logout</a><br>
  {% if current_user.role == 'worker' %}
    <a href="{{url_for('worker_dashboard')}}">Worker Dashboard</a>
    {% if current_user.upi_id %}<span style="color: green;">‚úì UPI Registered</span>{% endif %}
  {% else %}
    <a href="{{url_for('admin_dashboard')}}">Admin Dashboard</a>
    {% if current_user.role == 'superadmin' %}
      | <a href="{{url_for('create_admin')}}">Create New Admin</a>
    {% endif %}
  {% endif %}
  </div>
{% else %}
  <div class="auth-links">
    <a href="{{url_for('register')}}">Register as Worker</a> 
    <a href="{{url_for('login')}}">Login</a>
  </div>
{% endif %}

<div class="instructions">
    <strong>Instructions for Employees:</strong><br>
    1. On your phone/tablet, open browser (Chrome, Safari, etc.)<br>
    2. Type in address bar: <code>http://{{network_ip}}:5000/</code><br>
    3. Click "Register as Worker" to onboard<br>
    4. <strong>Add your UPI ID and QR code for instant payments</strong><br>
    5. After registration, login with your credentials
</div>

{% if current_user.is_authenticated and current_user.role == 'superadmin' %}
<div class="admin-only">
    <strong>üîí Super Admin Controls:</strong><br>
    ‚Ä¢ Only you can create new admin users<br>
    ‚Ä¢ Use "Create New Admin" link above<br>
    ‚Ä¢ Regular registration only creates workers
</div>
{% endif %}
</div>
'''

@app.route('/')
def home():
    network_ip = get_local_ip()
    return render_template_string(HOME_TPL, network_ip=network_ip)

# Public registration - ONLY WORKERS CAN REGISTER
REGISTER_TPL = '''
<!doctype html><title>Register as Worker</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
        color: #333;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
    }
    input, select, textarea {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    button {
        background-color: #4CAF50;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
    }
    button:hover {
        background-color: #45a049;
    }
    a {
        color: #4CAF50;
        text-decoration: none;
        display: inline-block;
        margin-top: 15px;
    }
    .section {
        margin: 20px 0;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 5px;
    }
    .upi-section {
        background-color: #e3f2fd;
        border-left: 4px solid #2196F3;
    }
    .required:after {
        content: " *";
        color: red;
    }
    .info-text {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
    }
    .alert {
        background-color: #fff3cd;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #ff9800;
        margin-bottom: 20px;
    }
</style>
<div class="container">
<h2>Worker Registration</h2>

<div class="alert">
    <strong>‚ö†Ô∏è Important:</strong><br>
    ‚Ä¢ This registration is for <strong>WORKERS ONLY</strong><br>
    ‚Ä¢ Admin accounts can only be created by existing superadmins<br>
    ‚Ä¢ Contact your supervisor if you need admin access
</div>

<form method=post enctype=multipart/form-data>
  <div class="section">
    <h3>Basic Information</h3>
    <label class="required">Full Name:</label>
    <input name=name placeholder="Enter your full name" required>
    
    <label class="required">Email (for login):</label>
    <input name=email type=email placeholder="example@email.com" required>
    
    <label class="required">Phone Number:</label>
    <input name=phone type="tel" placeholder="+91 9876543210" required>
    
    <label class="required">Password:</label>
    <input name=password type=password placeholder="Create a strong password" required>
    
    <input type="hidden" name="role" value="worker" readonly>
    <input type="text" value="Role: Worker (Fixed)" style="background-color: #f0f0f0;" readonly>
  </div>

  <div class="section upi-section">
    <h3>UPI Payment Details (Recommended)</h3>
    <p class="info-text">Add your UPI details for instant wage payments</p>
    
    <label>UPI ID:</label>
    <input name=upi_id type="text" placeholder="yourname@upi OR 9876543210@upi">
    <p class="info-text">Example: john@oksbi, 9876543210@paytm, etc.</p>
    
    <label>UPI QR Code (Screenshot/Photo):</label>
    <input name=upi_qr type=file accept="image/*">
    <p class="info-text">Upload a clear screenshot of your UPI QR code from any UPI app</p>
  </div>

  <div class="section">
    <h3>Verification Documents</h3>
    <label>Photo (face picture):</label>
    <input name=photo type=file accept="image/*">
    
    <label>Aadhaar image (front/back):</label>
    <input name=aadhaar type=file accept="image/*">
    
    <label>Secondary proof (PAN card, Voter ID, etc.):</label>
    <input name=proof type=file accept="image/*">
  </div>
  
  <button>Complete Worker Registration</button>
</form>
<p><a href="{{url_for('home')}}">‚Üê Back to Home</a></p>
</div>
'''

@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        name = request.form['name'].strip()
        email = request.form['email'].strip().lower()
        phone = request.form['phone'].strip()
        password = request.form['password']
        role = 'worker'  # Force worker role for public registration
        
        if User.query.filter_by(email=email).first():
            flash('Email already registered')
            return redirect(url_for('register'))
        
        # Save all uploaded files
        photo = save_upload(request.files.get('photo'))
        aadhaar = save_upload(request.files.get('aadhaar'))
        proof = save_upload(request.files.get('proof'))
        upi_qr = save_upload(request.files.get('upi_qr'))
        upi_id = request.form.get('upi_id', '').strip()
        
        u = User(
            name=name, email=email, phone=phone, role=role, 
            upi_id=upi_id, photo=photo, aadhaar=aadhaar, 
            proof=proof, upi_qr=upi_qr
        )
        u.set_password(password)
        db.session.add(u)
        db.session.commit()
        flash('Worker registration successful! Please login.')
        return redirect(url_for('login'))
    return render_template_string(REGISTER_TPL)

# Create Admin (Superadmin only)
CREATE_ADMIN_TPL = '''
<!doctype html><title>Create New Admin</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
        color: #333;
        border-bottom: 2px solid #d32f2f;
        padding-bottom: 10px;
    }
    input, select {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    button {
        background-color: #d32f2f;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
    }
    button:hover {
        background-color: #b71c1c;
    }
    a {
        color: #4CAF50;
        text-decoration: none;
        display: inline-block;
        margin-top: 15px;
    }
    .alert {
        background-color: #ffebee;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #d32f2f;
        margin-bottom: 20px;
    }
</style>
<div class="container">
<h2>Create New Admin Account</h2>

<div class="alert">
    <strong>üîí Super Admin Only:</strong><br>
    ‚Ä¢ Only superadmins can create new admin accounts<br>
    ‚Ä¢ Admins have full access to approve payments and view documents<br>
    ‚Ä¢ Use this feature responsibly
</div>

<form method=post>
    <label>Admin Name:</label>
    <input name=name placeholder="Enter admin full name" required>
    
    <label>Admin Email:</label>
    <input name=email type=email placeholder="admin@yourcompany.com" required>
    
    <label>Phone Number:</label>
    <input name=phone type="tel" placeholder="+91 9876543210">
    
    <label>Password:</label>
    <input name=password type=password placeholder="Create a strong password" required>
    
    <label>Confirm Password:</label>
    <input name=confirm_password type=password placeholder="Confirm password" required>
    
    <label>Admin Role:</label>
    <select name=role required>
        <option value="admin">Admin</option>
        <option value="superadmin">Super Admin (Full Control)</option>
    </select>
    
    <button>Create Admin Account</button>
</form>
<p><a href="{{url_for('admin_dashboard')}}">‚Üê Back to Admin Dashboard</a></p>
</div>
'''

@app.route('/create_admin', methods=['GET', 'POST'])
@login_required
def create_admin():
    # Only superadmins can create new admins
    if current_user.role != 'superadmin':
        flash('Access denied. Only superadmins can create admin accounts.')
        return redirect(url_for('home'))
    
    if request.method == 'POST':
        name = request.form['name'].strip()
        email = request.form['email'].strip().lower()
        phone = request.form['phone'].strip()
        password = request.form['password']
        confirm_password = request.form['confirm_password']
        role = request.form['role'].strip()
        
        # Validation
        if User.query.filter_by(email=email).first():
            flash('Email already registered')
            return redirect(url_for('create_admin'))
        
        if password != confirm_password:
            flash('Passwords do not match')
            return redirect(url_for('create_admin'))
        
        if len(password) < 6:
            flash('Password must be at least 6 characters')
            return redirect(url_for('create_admin'))
        
        # Create admin user
        u = User(
            name=name, email=email, phone=phone, role=role,
            created_by=current_user.id
        )
        u.set_password(password)
        db.session.add(u)
        db.session.commit()
        
        flash(f'{role.capitalize()} account created successfully!')
        return redirect(url_for('admin_dashboard'))
    
    return render_template_string(CREATE_ADMIN_TPL)

# Login
LOGIN_TPL = '''
<!doctype html><title>Login</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 400px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
        color: #333;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
    }
    input {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    button {
        background-color: #4CAF50;
        color: white;
        padding: 14px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
        margin-top: 10px;
    }
    button:hover {
        background-color: #45a049;
    }
    a {
        color: #4CAF50;
        text-decoration: none;
        display: block;
        text-align: center;
        margin-top: 15px;
    }
    .flash-message {
        background-color: #ffebee;
        color: #c62828;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        border-left: 4px solid #c62828;
    }
    .role-info {
        background-color: #e8f5e9;
        padding: 10px;
        border-radius: 5px;
        margin-top: 15px;
        font-size: 14px;
    }
</style>
<div class="container">
<h2>Login to Wage System</h2>
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="flash-message">
    {% for message in messages %}
      {{ message }}
    {% endfor %}
    </div>
  {% endif %}
{% endwith %}
<form method=post>
  <label>Email:</label>
  <input name=email type=email placeholder="Enter your registered email" required>
  
  <label>Password:</label>
  <input name=password type=password placeholder="Enter your password" required>
  
  <button>Login</button>
</form>

<div class="role-info">
    <strong>Role Information:</strong><br>
    ‚Ä¢ <strong>Workers:</strong> Submit wage requests, view status<br>
    ‚Ä¢ <strong>Admins:</strong> Approve payments, manage workers (created by superadmin)<br>
    ‚Ä¢ <strong>Super Admin:</strong> Full system control, create admins
</div>

<p><a href="{{url_for('register')}}">Register as Worker</a></p>
<p><a href="{{url_for('home')}}">‚Üê Back to Home</a></p>
</div>
'''

@app.route('/login', methods=['GET','POST'])
def login():
    if request.method == 'POST':
        email = request.form['email'].strip().lower()
        password = request.form['password']
        user = User.query.filter_by(email=email).first()
        if not user or not user.check_password(password):
            flash('Invalid email or password')
            return redirect(url_for('login'))
        login_user(user)
        if user.role == 'worker':
            return redirect(url_for('worker_dashboard'))
        return redirect(url_for('admin_dashboard'))
    return render_template_string(LOGIN_TPL)

@app.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('home'))

# Worker dashboard
WORKER_TPL = '''
<!doctype html><title>Worker Dashboard</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2, h3 {
        color: #333;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
    }
    input, select, textarea {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    button {
        background-color: #4CAF50;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px 0;
    }
    button:hover {
        background-color: #45a049;
    }
    a {
        color: #4CAF50;
        text-decoration: none;
        padding: 8px 16px;
        margin: 5px;
        border: 1px solid #4CAF50;
        border-radius: 4px;
        display: inline-block;
    }
    a:hover {
        background-color: #4CAF50;
        color: white;
    }
    .nav {
        background-color: #f0f0f0;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .requests-list {
        list-style-type: none;
        padding: 0;
    }
    .requests-list li {
        padding: 15px;
        margin: 10px 0;
        background-color: #f9f9f9;
        border-left: 4px solid #4CAF50;
        border-radius: 4px;
    }
    .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        margin-left: 10px;
    }
    .pending { background-color: #fff3cd; color: #856404; }
    .approved { background-color: #d4edda; color: #155724; }
    .rejected { background-color: #f8d7da; color: #721c24; }
    .paid { background-color: #cce5ff; color: #004085; }
    .upi-info {
        background-color: #e3f2fd;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        border-left: 4px solid #2196F3;
    }
    .qr-code {
        max-width: 200px;
        max-height: 200px;
        border: 1px solid #ddd;
        padding: 5px;
        margin: 10px 0;
    }
</style>
<div class="container">
<h2>Worker Dashboard - {{current_user.name}}</h2>
<div class="nav">
    <a href="{{url_for('home')}}">Home</a> | 
    <a href="{{url_for('logout')}}">Logout</a>
</div>

<div class="upi-info">
    <strong>üí≥ Your UPI Information:</strong><br>
    {% if current_user.upi_id %}
        <strong>UPI ID:</strong> {{current_user.upi_id}}<br>
        {% if current_user.upi_qr %}
            <strong>QR Code:</strong><br>
            <img src="{{url_for('download_file', filename=current_user.upi_qr)}}" class="qr-code" alt="UPI QR Code">
        {% else %}
            <p>No QR code uploaded.</p>
        {% endif %}
    {% else %}
        <p>No UPI ID registered. Add UPI details during registration for instant payments.</p>
    {% endif %}
</div>

<h3>Log Task</h3>
<form method=post action="{{url_for('log_task')}}">
  <label>Title:</label>
  <input name=title placeholder="What work did you do?" required>
  
  <label>Details:</label>
  <textarea name=details placeholder="Describe the work in detail..." rows="3"></textarea>
  
  <label>Duration/Output:</label>
  <input name=duration placeholder="e.g., 8 hours, 50 units, etc.">
  
  <button>Save Task</button>
</form>

<hr>

<h3>Request Wage Payment</h3>
<form method=post action="{{url_for('request_wage')}}">
  <label>Amount (‚Çπ):</label>
  <input name=amount type=number step="0.01" placeholder="1000.00" required>
  
  <label>Preferred Payment Mode:</label>
  <select name=mode required>
    <option value="upi" {% if current_user.upi_id %}selected{% endif %}>UPI (Recommended)</option>
    <option value="online">Online Transfer</option>
    <option value="cash">Cash</option>
  </select>
  
  <label>Reference/Reason:</label>
  <input name=reason placeholder="For task/work done on [date]">
  
  <button>Submit Wage Request</button>
</form>

<hr>

<h3>Your Wage Requests</h3>
<ul class="requests-list">
{% for r in requests %}
  <li>
    <strong>‚Çπ{{r.amount}}</strong> - {{r.mode|upper}} 
    <span class="status {{r.status}}">{{r.status|title}}</span><br>
    <small>Submitted: {{r.created_at.strftime('%Y-%m-%d %H:%M')}}</small>
    {% if r.reason %}<br>Reason: {{r.reason}}{% endif %}
    {% if r.admin_note %}<br><strong>Admin Note:</strong> {{r.admin_note}}{% endif %}
    {% if r.transaction_id and r.status == 'paid' %}<br><strong>Transaction ID:</strong> {{r.transaction_id}}{% endif %}
  </li>
{% else %}
  <li>No wage requests submitted yet.</li>
{% endfor %}
</ul>
</div>
'''

@app.route('/worker')
@login_required
def worker_dashboard():
    if current_user.role != 'worker':
        return redirect(url_for('admin_dashboard'))
    reqs = WageRequest.query.filter_by(user_id=current_user.id).order_by(WageRequest.created_at.desc()).all()
    return render_template_string(WORKER_TPL, requests=reqs)

@app.route('/log_task', methods=['POST'])
@login_required
def log_task():
    if current_user.role != 'worker':
        flash('Access denied')
        return redirect(url_for('home'))
    t = Task(user_id=current_user.id, title=request.form.get('title'), details=request.form.get('details'), duration=request.form.get('duration'))
    db.session.add(t)
    db.session.commit()
    flash('Task logged successfully!')
    return redirect(url_for('worker_dashboard'))

@app.route('/request_wage', methods=['POST'])
@login_required
def request_wage():
    if current_user.role != 'worker':
        flash('Access denied')
        return redirect(url_for('home'))
    try:
        amount = float(request.form.get('amount'))
    except:
        flash('Invalid amount')
        return redirect(url_for('worker_dashboard'))
    mode = request.form.get('mode')
    reason = request.form.get('reason')
    
    if mode == 'upi' and not current_user.upi_id:
        flash('Please add your UPI ID during registration before requesting UPI payment')
        return redirect(url_for('worker_dashboard'))
    
    wr = WageRequest(user_id=current_user.id, amount=amount, mode=mode, reason=reason)
    db.session.add(wr)
    db.session.commit()
    flash('Wage request submitted successfully!')
    return redirect(url_for('worker_dashboard'))

# Admin dashboard
ADMIN_TPL = '''
<!doctype html><title>Admin Dashboard</title>
<style>
    body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2, h3 {
        color: #333;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
    }
    .nav {
        background-color: #f0f0f0;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    a {
        color: #4CAF50;
        text-decoration: none;
        padding: 8px 16px;
        margin: 5px;
        border: 1px solid #4CAF50;
        border-radius: 4px;
        display: inline-block;
    }
    a:hover {
        background-color: #4CAF50;
        color: white;
    }
    .request-item {
        padding: 15px;
        margin: 10px 0;
        background-color: #f9f9f9;
        border-radius: 5px;
        border-left: 4px solid #ff9800;
    }
    .user-item {
        padding: 10px;
        margin: 5px 0;
        background-color: #f0f0f0;
        border-radius: 3px;
    }
    button {
        padding: 8px 16px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .btn-approve { background-color: #4CAF50; color: white; }
    .btn-reject { background-color: #f44336; color: white; }
    .btn-paid { background-color: #2196F3; color: white; }
    .btn-delete { background-color: #757575; color: white; }
    .status-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 12px;
        margin-left: 10px;
    }
    .pending { background-color: #fff3cd; color: #856404; }
    .approved { background-color: #d4edda; color: #155724; }
    .rejected { background-color: #f8d7da; color: #721c24; }
    .paid { background-color: #cce5ff; color: #004085; }
    .role-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        margin-left: 5px;
    }
    .worker { background-color: #4CAF50; color: white; }
    .admin { background-color: #2196F3; color: white; }
    .superadmin { background-color: #d32f2f; color: white; }
    .tabs {
        display: flex;
        border-bottom: 2px solid #ddd;
        margin-bottom: 20px;
    }
    .tab {
        padding: 10px 20px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }
    .tab.active {
        border-bottom: 2px solid #4CAF50;
        font-weight: bold;
    }
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    .superadmin-only {
        background-color: #ffebee;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        border-left: 4px solid #d32f2f;
    }
</style>
<div class="container">
<h2>Admin Dashboard - {{current_user.name}} 
    <span class="role-badge {{current_user.role}}">{{current_user.role|upper}}</span>
</h2>
<div class="nav">
    <a href="{{url_for('home')}}">Home</a> | 
    <a href="{{url_for('logout')}}">Logout</a> |
    <a href="{{url_for('export_csv')}}">Export CSV</a>
    {% if current_user.role == 'superadmin' %}
    | <a href="{{url_for('create_admin')}}">Create New Admin</a>
    {% endif %}
</div>

{% if current_user.role == 'superadmin' %}
<div class="superadmin-only">
    <strong>üîí Super Admin Privileges:</strong> You can create new admins and manage all users.
</div>
{% endif %}

<div class="tabs">
    <div class="tab active" onclick="switchTab('requests')">Pending Requests ({{pending|length}})</div>
    <div class="tab" onclick="switchTab('users')">All Users ({{users|length}})</div>
    <div class="tab" onclick="switchTab('history')">Payment History</div>
</div>

<div id="requests-tab" class="tab-content active">
    <h3>Pending Wage Requests</h3>
    {% if pending %}
      {% for r in pending %}
        <div class="request-item">
          <strong>Request #{{r.id}}</strong> 
          <span class="status-badge {{r.status}}">{{r.status|title}}</span><br>
          <strong>Worker:</strong> {{r.user.name}} 
          <span class="role-badge {{r.user.role}}">{{r.user.role}}</span><br>
          <strong>Contact:</strong> {{r.user.email}} | {{r.user.phone or 'N/A'}}<br>
          <strong>Amount:</strong> ‚Çπ{{r.amount}} | <strong>Mode:</strong> {{r.mode|upper}}<br>
          <strong>Reason:</strong> {{r.reason}}<br>
          <strong>Submitted:</strong> {{r.created_at.strftime('%Y-%m-%d %H:%M')}}<br>
          
          {% if r.user.upi_id %}
          <div style="background-color: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0;">
            <strong>UPI:</strong> {{r.user.upi_id}}<br>
            {% if r.user.upi_qr %}
              <a href="{{url_for('download_file', filename=r.user.upi_qr)}}" target="_blank">View QR Code</a>
            {% endif %}
          </div>
          {% endif %}
          
          <form method=post action="{{url_for('admin_action', req_id=r.id)}}">
            <input name=admin_note placeholder="Admin note (optional)" style="width: 300px; padding: 8px;">
            {% if r.mode in ['upi', 'online'] %}
              <br><input name=transaction_id placeholder="Transaction ID (required for UPI/Online)" style="width: 300px; padding: 8px; margin-top: 5px;">
            {% endif %}
            <br>
            <button class="btn-approve" name=action value="approve">Approve</button>
            <button class="btn-reject" name=action value="reject">Reject</button>
            <button class="btn-paid" name=action value="mark_paid">Mark as Paid</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p>No pending requests.</p>
    {% endif %}
</div>

<div id="users-tab" class="tab-content">
    <h3>System Users</h3>
    <div style="max-height: 400px; overflow-y: auto; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
      {% for u in users %}
        <div class="user-item">
          <strong>{{u.name}}</strong> 
          <span class="role-badge {{u.role}}">{{u.role|upper}}</span><br>
          <strong>Email:</strong> {{u.email}}<br>
          <strong>Phone:</strong> {{u.phone or 'N/A'}}<br>
          {% if u.upi_id %}<strong>UPI:</strong> {{u.upi_id}}<br>{% endif %}
          <strong>Registered:</strong> {{u.created_at.strftime('%Y-%m-%d')}}<br>
          
          {% if current_user.role == 'superadmin' and u.role != 'superadmin' and u.id != current_user.id %}
          <form method=post action="{{url_for('delete_user', user_id=u.id)}}" style="margin-top: 5px;" onsubmit="return confirm('Delete user {{u.name}}?');">
            <button class="btn-delete" type="submit">Delete User</button>
          </form>
          {% endif %}
        </div>
      {% endfor %}
    </div>
</div>

<div id="history-tab" class="tab-content">
    <h3>Payment History</h3>
    {% if paid_requests %}
      {% for r in paid_requests %}
        <div class="user-item">
          <strong>‚Çπ{{r.amount}} - {{r.mode|upper}}</strong> 
          <span class="status-badge paid">PAID</span><br>
          <strong>Worker:</strong> {{r.user.name}}<br>
          <strong>Paid on:</strong> {{r.created_at.strftime('%Y-%m-%d %H:%M')}}<br>
          {% if r.transaction_id %}<strong>Transaction ID:</strong> {{r.transaction_id}}<br>{% endif %}
          {% if r.admin_note %}<strong>Note:</strong> {{r.admin_note}}{% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p>No payment history.</p>
    {% endif %}
</div>

<script>
function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Activate selected tab
    event.target.classList.add('active');
}
</script>
</div>
'''

@app.route('/admin')
@login_required
def admin_dashboard():
    if current_user.role not in ['admin', 'superadmin']:
        flash('Access denied. Admin privileges required.')
        return redirect(url_for('home'))
    
    # Get pending requests with user info
    pending = WageRequest.query.filter(WageRequest.status != 'paid')\
               .join(User, WageRequest.user_id == User.id)\
               .order_by(WageRequest.created_at.desc()).all()
    
    users = User.query.order_by(User.created_at.desc()).all()
    
    paid_requests = WageRequest.query.filter_by(status='paid')\
                    .join(User, WageRequest.user_id == User.id)\
                    .order_by(WageRequest.created_at.desc())\
                    .limit(20).all()
    
    return render_template_string(ADMIN_TPL, 
                                 pending=pending, 
                                 users=users, 
                                 paid_requests=paid_requests)

@app.route('/admin/action/<int:req_id>', methods=['POST'])
@login_required
def admin_action(req_id):
    if current_user.role not in ['admin', 'superadmin']:
        flash('Access denied')
        return redirect(url_for('home'))
    
    r = WageRequest.query.get_or_404(req_id)
    action = request.form.get('action')
    note = request.form.get('admin_note')
    transaction_id = request.form.get('transaction_id', '').strip()
    
    if action == 'approve':
        r.status = 'approved'
        r.admin_note = note
    elif action == 'reject':
        r.status = 'rejected'
        r.admin_note = note
    elif action == 'mark_paid':
        r.status = 'paid'
        r.admin_note = note
        r.transaction_id = transaction_id
        r.paid_by = current_user.id
    
    db.session.commit()
    flash(f'Request #{req_id} {action}d successfully!')
    return redirect(url_for('admin_dashboard'))

# Delete user (Superadmin only)
@app.route('/delete_user/<int:user_id>', methods=['POST'])
@login_required
def delete_user(user_id):
    if current_user.role != 'superadmin':
        flash('Access denied. Only superadmins can delete users.')
        return redirect(url_for('admin_dashboard'))
    
    user_to_delete = User.query.get_or_404(user_id)
    
    # Prevent deleting yourself or other superadmins
    if user_to_delete.id == current_user.id:
        flash('Cannot delete your own account!')
    elif user_to_delete.role == 'superadmin':
        flash('Cannot delete other superadmin accounts!')
    else:
        # Delete user's wage requests and tasks first
        WageRequest.query.filter_by(user_id=user_id).delete()
        Task.query.filter_by(user_id=user_id).delete()
        
        # Delete the user
        db.session.delete(user_to_delete)
        db.session.commit()
        flash(f'User {user_to_delete.name} deleted successfully!')
    
    return redirect(url_for('admin_dashboard'))

@app.route('/export')
@login_required
def export_csv():
    if current_user.role not in ['admin', 'superadmin']:
        return "Forbidden", 403
    si = StringIO()
    cw = csv.writer(si)
    cw.writerow(['id','user_email','user_name','amount','mode','status','reason','created_at','admin_note','transaction_id'])
    for r in WageRequest.query.order_by(WageRequest.created_at.desc()).all():
        u = User.query.get(r.user_id)
        cw.writerow([r.id, u.email if u else '', u.name if u else '', r.amount, r.mode, r.status, (r.reason or ''), r.created_at, (r.admin_note or ''), (r.transaction_id or '')])
    output = si.getvalue()
    return send_file(StringIO(output), mimetype='text/csv', as_attachment=True, download_name='wage_requests.csv')

@app.route('/uploads/<path:filename>')
@login_required
def download_file(filename):
    # Check if filename is None or empty
    if not filename or filename == 'None':
        return "File not found", 404
        
    # Only admin/superadmin may view full documents. Workers can only view their own files
    u = User.query.filter((User.photo == filename) | (User.aadhaar == filename) | (User.proof == filename) | (User.upi_qr == filename)).first()
    if not u:
        return "File not found", 404
    if current_user.role in ['admin', 'superadmin'] or current_user.id == u.id:
        filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        if os.path.exists(filepath):
            return send_file(filepath)
        return "File not found", 404
    return "Forbidden", 403

if __name__ == '__main__':
    # Call initialization function
    initialize_database()
    
    # Get local IP address
    local_ip = get_local_ip()
    print("\n" + "="*60)
    print("WAGE REQUEST SYSTEM STARTED!")
    print("="*60)
    print(f"Local access:  http://127.0.0.1:5000/")
    print(f"Network access: http://{local_ip}:5000/")
    print("="*60)
    
    # Show superadmin credentials
    with app.app_context():
        superadmin = User.query.filter_by(role='superadmin').first()
        if superadmin:
            print(f"Super Admin Login:")
            print(f"Email: {superadmin.email}")
            print("Password: superadmin123")
        else:
            print("ERROR: No superadmin found!")
    
    print("\nInstructions for employees on same WiFi:")
    print(f"1. Open browser on phone/tablet")
    print(f"2. Type: http://{local_ip}:5000/")
    print(f"3. Register as Worker (cannot register as admin)")
    print("="*60 + "\n")
    
    # Run with Waitress (production WSGI server for Windows)
    from waitress import serve
    serve(app, host='0.0.0.0', port=5000, threads=10)
